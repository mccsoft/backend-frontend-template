trigger:
  branches:
    include:
      - master
      - main
      - feature/ci-*
  paths:
    exclude:
      - docs/*

variables:
  BUILD_NUMBER: 0.1.$(Build.BuildId)
  REACT_APP_BUILD_NUMBER: 0.1.$(Build.BuildId)
  solution: 'webapi/MccSoft.TemplateApp.sln'
  project: 'webapi/src/MccSoft.TemplateApp.App/MccSoft.TemplateApp.App.csproj'

stages:
  - stage: Build
    jobs:
      - job: Build_Backend_Frontend
        pool:
          vmImage: 'ubuntu-latest'

        steps:
          - checkout: self
            fetchDepth: 1
            submodules: true

          - template: ./shared/cache-node-modules.yml
          # - template: ./shared/azure-pipelines-tests.yml
          - template: ./shared/azure-pipelines-build.yml

          - script: |
              docker login $(DOCKER_REGISTRY) -u $(DOCKER_USER) -p $(DOCKER_TOKEN)
            displayName: 'Authenticate at Container Registry'

          - task: Docker@2
            condition: succeeded()
            inputs:
              repository: $(DOCKER_REGISTRY)
              command: 'buildAndPush'
              Dockerfile: 'publish/Dockerfile'
              buildContext: '$(Build.SourcesDirectory)/publish'
              ${{ if eq(variables['Build.SourceBranch'], 'refs/heads/master') }}:
                tags: |
                  $(BUILD_NUMBER)
                  latest
              ${{ else }}:
                tags: |
                  $(BUILD_NUMBER)
            displayName: 'build and push docker image'

          - publish: './publish'
            artifact: 'publish'

          - publish: './docker-compose.yaml'
            artifact: 'docker-compose'

          - publish: './nginx'
            artifact: 'nginx'

          - publish: './scripts/deploy'
            artifact: 'scripts'

  - stage: UI_Tests
    dependsOn:
      - Build
    jobs:
      - job: UI_Tests
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - template: ./tests/azure-pipelines-storybook-tests.yml

  - stage: DeployToDev
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment:
        environment:
          name: 'DEV'
          resourceType: VirtualMachine
        strategy:
          runOnce:
            deploy:
              steps:
                - template: ./azure-deploy-template.yml

  - stage: TagDevSources
    dependsOn: DeployToDev
    condition: succeeded()
    jobs:
      - job:
        condition: succeeded()
        pool:
          vmImage: ubuntu-latest
        steps:
          - checkout: self
            persistCredentials: true
          - script: |
              git tag 'dev' -f
              git push origin 'dev' -f --tags

  - stage: DeployToProd
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment:
        environment:
          name: 'PROD'
          resourceType: VirtualMachine
        strategy:
          runOnce:
            deploy:
              steps:
                - template: ./azure-deploy-template.yml

  - stage: TagProdSources
    dependsOn: DeployToProd
    condition: succeeded()
    jobs:
      - job:
        condition: succeeded()
        pool:
          vmImage: ubuntu-latest
        steps:
          - checkout: self
            persistCredentials: true
          - script: |
              git tag 'prod' -f
              git push origin 'prod' -f --tags
