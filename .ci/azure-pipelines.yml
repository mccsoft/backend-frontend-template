trigger:
  branches:
    include:
      - master
      - main
      - feature/ci-*
  paths:
    exclude:
      - docs/*

variables:
  BUILD_NUMBER: 0.1.$(Build.BuildId)
  REACT_APP_BUILD_NUMBER: 0.1.$(Build.BuildId)
  solution: 'webapi/MccSoft.TemplateApp.sln'
  project: 'webapi/src/MccSoft.TemplateApp.App/MccSoft.TemplateApp.App.csproj'

stages:
  - stage: Build
  dependsOn: []
    jobs:
      - job: Build_Backend_Frontend
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            fetchDepth: 1
            submodules: true

          - template: ./shared/cache-node-modules.yml
          - template: ./shared/azure-pipelines-build.yml
          - template: ./shared/azure-pipelines-docker.yml

  - stage: Test
    dependsOn: []
    jobs:
      - job: Test
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            fetchDepth: 1
            submodules: true
          - template: ./shared/cache-node-modules.yml
          - template: ./shared/azure-pipelines-tests.yml

  - stage: DockerTagLatest
    dependsOn: 
      - Build
      - Test
    condition: succeeded()
    jobs:
      - job: DockerTagLatest
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - template: ./shared/docker-add-tag-latest.yml

  - stage: DeployToDev
    dependsOn: DockerTagLatest
    condition: succeeded()
    jobs:
      - deployment:
        environment:
          name: 'DEV'
          resourceType: VirtualMachine
        strategy:
          runOnce:
            deploy:
              steps:
                - template: ./azure-deploy-template.yml

  - stage: TagDevSources
    dependsOn: DeployToDev
    condition: succeeded()
    jobs:
      - job:
        condition: succeeded()
        pool:
          vmImage: ubuntu-latest
        steps:
          - checkout: self
            persistCredentials: true
          - script: |
              git tag 'dev' -f
              git push origin 'dev' -f --tags

  - stage: DeployToProd
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment:
        environment:
          name: 'PROD'
          resourceType: VirtualMachine
        strategy:
          runOnce:
            deploy:
              steps:
                - template: ./azure-deploy-template.yml

  - stage: TagProdSources
    dependsOn: DeployToProd
    condition: succeeded()
    jobs:
      - job:
        condition: succeeded()
        pool:
          vmImage: ubuntu-latest
        steps:
          - checkout: self
            persistCredentials: true
          - script: |
              git tag 'prod' -f
              git push origin 'prod' -f --tags

  - stage: UI_Tests
    dependsOn:
      - Build
    jobs:
      - job: UI_Tests
        pool:
          vmImage: 'ubuntu-latest'
        container: mcr.microsoft.com/playwright:v1.30.0-focal
        steps:
          - template: ./tests/azure-pipelines-storybook-tests.yml
