parameters:
  - name: restartDeployment
    type: boolean
    default: false
  - name: Environment
    displayName: Environment to deploy
    type: string
    default: dev
  - name: BuildAppNumber
    displayName: Build number to deploy
    type: string
    default: latest

steps:
  - template: ./steps/promote-docker-image.yml
    parameters:
      Environment: ${{ parameters.Environment }}
      BuildAppNumber: ${{ parameters.BuildAppNumber }}

  - checkout: self
    fetchDepth: 1
    submodules: true

  - task: Bash@3
    displayName: '[bash] Prepare versions and environment variables'
    inputs:
      filePath: '$(Build.SourcesDirectory)/k8s/aks-rancher/prepare-k8s-templates.sh'
      workingDirectory: $(Build.SourcesDirectory)/k8s/aks-rancher
      arguments: '${{ parameters.Environment }}'


  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: '$(Build.SourcesDirectory)/k8s/aks-rancher/deploy_${{ parameters.Environment }}'
      ArtifactName: 'deploy_${{ parameters.Environment }}'
      publishLocation: 'Container'

  - task: KubernetesManifest@1
    displayName: '[k8s]: applying *.yaml'
    inputs:
      action: 'deploy'
      connectionType: 'kubernetesServiceConnection'
      # $K8S_NAMESPACE is exported from prepare-k8s-templates.sh
      namespace: '$(K8S_NAMESPACE)'
      manifests: |
        $(Build.SourcesDirectory)/k8s/aks-rancher/deploy_${{ parameters.Environment }}/*.yaml
      containers: |
        $(ACR_REGISTRY)/$(ACR_REPOSITORY):${{ parameters.BuildAppNumber }}
      rolloutStatusTimeout: 120

  - ${{ if eq(parameters.restartDeployment, true) }}:
      - task: Kubernetes@1
        displayName: '[k8s]: force restart deployment $(appName)'
        inputs:
          connectionType: 'Kubernetes Service Connection'
          # $K8S_NAMESPACE is exported from prepare-k8s-templates.sh
          namespace: '$(K8S_NAMESPACE)'
          command: 'rollout'
          arguments: 'restart deployment $(appName)'
