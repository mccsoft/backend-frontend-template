steps:
  - task: DownloadPipelineArtifact@2
    inputs:
      path: './'

  - script: |
      export DOCKER_IMAGE="$(DOCKER_REGISTRY):$(BUILD_NUMBER)";
      export KUBECONFIG=/home/k3s_remote/k3s.conf

      envsubst < app.yaml > app.yaml.tmp && mv app.yaml.tmp app.yaml
      cat app.yaml

      kubectl apply -f postgres.yaml
      kubectl apply -f app.yaml
    displayName: deploy

  # - script: |
  #     sudo docker login $(DOCKER_REGISTRY) -u $(DOCKER_USER) -p $(DOCKER_TOKEN)
  #   displayName: 'Authenticate at Container Registry'
