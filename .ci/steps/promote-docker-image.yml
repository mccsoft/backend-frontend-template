parameters:
  - name: Environment
    displayName: Environment to deploy
    type: string
    default: dev
  - name: BuildAppNumber
    displayName: Build number to deploy
    type: string
    default: latest

steps:
  - script: 'echo "Dummy Step"'
    
  - ${{ if and(not(startsWith(parameters.Environment, 'dev')), not(startsWith(parameters.Environment, 'today'))) }}:
      - task: Docker@2
        displayName: '[Docker]: login'
        inputs:
          containerRegistry: $(connectorACR)
          command: 'login'

      - task: Bash@3
        displayName: '[ACR]: promote image to <repo>/$(parameters.Environment)'
        inputs:
          targetType: 'inline'
          script: |
            set -e
            TAG="${{ parameters.BuildAppNumber }}"

            FROM="${ACR_REGISTRY}/${ACR_REPOSITORY}:${TAG}"
            TO="${ACR_REGISTRY}/${ACR_REPOSITORY}/${{ parameters.Environment }}:${TAG}"

            echo "Promoting image inside ACR:"
            echo "  ${FROM} -> ${TO}"

            docker buildx imagetools create --tag "${TO}" "${FROM}"
            echo "##vso[task.setvariable variable=ACR_REPOSITORY]${ACR_REPOSITORY}/${{ parameters.Environment }}"

      - task: Docker@2
        displayName: '[Docker]: logout'
        inputs:
          containerRegistry: $(connectorACR)
          command: 'logout'
